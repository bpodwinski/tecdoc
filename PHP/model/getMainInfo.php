<?php
include_once __DIR__ . "/../config.php";
include_once __DIR__ . "/../model/database.php";

global $langId;
global $dlnr;

$query = <<<SQL
SELECT DISTINCT
    T.reference AS `reference`,
    ARTNR_SHORT AS `reference_courte`,
    EAN AS `ean13`,
    T.nom AS `nom`,
    STANDARD_GROUP,
    ASSEMBLY_GROUP,
    PURPOSE_GROUP
FROM (
    -- PASSANGER
    SELECT
        T400.ARTNR AS `reference`,
        P.ARTNR_SHORT,
        IFNULL((SELECT
            GROUP_CONCAT(DISTINCT T209.EANNR)
            FROM `209` AS T209
            WHERE T209.ARTNR = T200.ARTNR AND T209.DLNR = T200.DLNR), '') AS EAN,
        IFNULL(GET_BEZNR(T320.BEZNR, $langId), '') AS `nom`,
        IFNULL(GET_BEZNR(T323.BEZNR, $langId), '') AS STANDARD_GROUP,
        IFNULL(GET_BEZNR(T324.BEZNR, $langId), '') AS ASSEMBLY_GROUP,
        IFNULL(GET_BEZNR(T325.BEZNR, $langId), '') AS PURPOSE_GROUP
    FROM `200_fixed` AS P
        JOIN `400` AS T400 ON T400.ARTNR = P.ARTNR AND T400.DLNR = P.DLNR AND T400.VKNZIELART = 2
        JOIN `120` AS T120 ON T120.KTYPNR = T400.VKNZIELNR
        JOIN `110` AS T110 ON T110.KMODNR = T120.KMODNR
        JOIN `100` AS T100 ON T100.HERNR = T110.HERNR
        JOIN `200` AS T200 ON T200.ARTNR = P.ARTNR AND T200.DLNR = P.DLNR
        JOIN `211` AS T211 ON T211.ARTNR = T200.ARTNR AND T211.DLNR = T200.DLNR
        JOIN `320` AS T320 ON T320.GENARTNR = T211.GENARTNR
        LEFT JOIN `323` AS T323 ON T323.NARTNR = T320.NARTNR
        LEFT JOIN `324` AS T324 ON T324.BGNR = T320.BGNR
        LEFT JOIN `325` AS T325 ON T325.VERWNR = T320.VERWNR
    WHERE P.ARTNR_SHORT = CLEAN_NUMBER('.$id.') AND P.DLNR = $dlnr

        UNION

    -- TRUCK
    SELECT
        T400.ARTNR AS `reference`,
        P.ARTNR_SHORT,
        IFNULL((SELECT
            GROUP_CONCAT(DISTINCT T209.EANNR)
            FROM `209` AS T209
            WHERE T209.ARTNR = T200.ARTNR AND T209.DLNR = T200.DLNR), '') AS EAN,
        IFNULL(GET_BEZNR(T320.BEZNR, $langId), '') AS `nom`,
        IFNULL(GET_BEZNR(T323.BEZNR, $langId), '') AS STANDARD_GROUP,
        IFNULL(GET_BEZNR(T324.BEZNR, $langId), '') AS ASSEMBLY_GROUP,
        IFNULL(GET_BEZNR(T325.BEZNR, $langId), '') AS PURPOSE_GROUP
    FROM `200_fixed` AS P
        JOIN `400` AS T400 ON T400.ARTNR = P.ARTNR AND T400.DLNR = P.DLNR AND T400.VKNZIELART = 16
        JOIN `532` AS T532 ON T532.NTYPNR = T400.VKNZIELNR
        JOIN `110` AS T110 ON T110.KMODNR = T532.KMODNR
        JOIN `100` AS T100 ON T100.HERNR = T110.HERNR
        JOIN `200` AS T200 ON T200.ARTNR = P.ARTNR AND T200.DLNR = P.DLNR
        JOIN `211` AS T211 ON T211.ARTNR = T200.ARTNR AND T211.DLNR = T200.DLNR
        JOIN `320` AS T320 ON T320.GENARTNR = T211.GENARTNR
        LEFT JOIN `323` AS T323 ON T323.NARTNR = T320.NARTNR
        LEFT JOIN `324` AS T324 ON T324.BGNR = T320.BGNR
        LEFT JOIN `325` AS T325 ON T325.VERWNR = T320.VERWNR
    WHERE P.ARTNR_SHORT = CLEAN_NUMBER('.$id.') AND P.DLNR = $dlnr
    ) AS T
ORDER BY `reference`;
SQL;
