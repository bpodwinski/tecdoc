-- INFO ABOUT PRODUCT ARE POSSIBLE SHOW ONLY FOR PRODUCTS FROM MAIN TABLE `200`
-- ELSE NEED SEARCH ANALOG FROM MAIN TABLE AND THEN CAN SUBSTITUTE NECESSARY INFO FOR CROSSREFERENCE PRODUCT
SET @SPRACHNR = 6;  -- SELECTED ID LANG (ENGLISH)
SET @ARTNR = 'AE-HY-046';
SET @DLNR = 6355;

SELECT DISTINCT
    T.référence AS `référence`,
    ARTNR_SHORT AS `référence courte`,
    EAN AS `ean13`,
    T.GENARTNR,
    T.nom AS `nom`,
    STANDARD_GROUP,
    ASSEMBLY_GROUP,
    PURPOSE_GROUP,
    CROSS_BRAND,
    GROUP_CONCAT(DISTINCT NAME_CRY SEPARATOR ',') AS `NAME_CRY`,
    GROUP_CONCAT(DISTINCT VALUE_CRY SEPARATOR ',') AS `VALUE_CRY`,
    GROUP_CONCAT(DISTINCT T.ktype ORDER BY T.ktype SEPARATOR ',') AS `ktype`
FROM (
    -- PASSANGER
    SELECT
        T400.ARTNR AS `référence`,
        P.ARTNR_SHORT,
        IFNULL((SELECT
            GROUP_CONCAT(DISTINCT T209.EANNR)
            FROM `209` AS T209
            WHERE T209.ARTNR = T200.ARTNR AND T209.DLNR = T200.DLNR), '') AS EAN,
        T320.GENARTNR,
	    IFNULL(GET_BEZNR(T320.BEZNR, @SPRACHNR), '') AS `nom`,
        IFNULL(GET_BEZNR(T323.BEZNR, @SPRACHNR), '') AS STANDARD_GROUP,
        IFNULL(GET_BEZNR(T324.BEZNR, @SPRACHNR), '') AS ASSEMBLY_GROUP,
        IFNULL(GET_BEZNR(T325.BEZNR, @SPRACHNR), '') AS PURPOSE_GROUP,
        GET_LBEZNR(T1000.LBEZNR, @SPRACHNR) AS CROSS_BRAND,
        IFNULL(GET_BEZNR(T050.BEZNR, @SPRACHNR), '') AS NAME_CRY,
        IF(T050.TYP <> 'K',
            T210.KRITWERT,
            IFNULL(GET_BEZNR_FOR_KEY_TABLE(T050.TABNR, T210.KRITWERT, @SPRACHNR), '')
        ) AS VALUE_CRY,
        T120.KTYPNR AS `ktype`
    FROM `200_fixed` AS P
        JOIN `400` AS T400 ON T400.ARTNR = P.ARTNR AND T400.DLNR = P.DLNR AND T400.VKNZIELART = 2
        JOIN `120` AS T120 ON T120.KTYPNR = T400.VKNZIELNR
        JOIN `110` AS T110 ON T110.KMODNR = T120.KMODNR
        JOIN `100` AS T100 ON T100.HERNR = T110.HERNR
        JOIN `200` AS T200 ON T200.ARTNR = P.ARTNR AND T200.DLNR = P.DLNR
        JOIN `211` AS T211 ON T211.ARTNR = T200.ARTNR AND T211.DLNR = T200.DLNR
        JOIN `320` AS T320 ON T320.GENARTNR = T211.GENARTNR
        JOIN `210` AS T210 ON T210.ARTNR = T200.ARTNR AND T210.DLNR = T200.DLNR
        JOIN `050` AS T050 ON T050.DLNR IN (T200.DLNR, 9999) AND T050.KRITNR = T210.KRITNR
        JOIN `203` AS T203 ON T203.ARTNR = P.ARTNR AND T203.DLNR = P.DLNR
        JOIN `100` AS T1000 ON T100.HERNR = T203.KHERNR
        LEFT JOIN `323` AS T323 ON T323.NARTNR = T320.NARTNR
        LEFT JOIN `324` AS T324 ON T324.BGNR = T320.BGNR
        LEFT JOIN `325` AS T325 ON T325.VERWNR = T320.VERWNR
    WHERE P.ARTNR_SHORT = CLEAN_NUMBER(@ARTNR) AND P.DLNR = @DLNR

        UNION

    -- TRUCK
    SELECT
        T400.ARTNR AS `référence`,
        P.ARTNR_SHORT,
        IFNULL((SELECT
            GROUP_CONCAT(DISTINCT T209.EANNR)
            FROM `209` AS T209
            WHERE T209.ARTNR = T200.ARTNR AND T209.DLNR = T200.DLNR), '') AS EAN,
        T320.GENARTNR,
        IFNULL(GET_BEZNR(T320.BEZNR, @SPRACHNR), '') AS `nom`,
        IFNULL(GET_BEZNR(T323.BEZNR, @SPRACHNR), '') AS STANDARD_GROUP,
        IFNULL(GET_BEZNR(T324.BEZNR, @SPRACHNR), '') AS ASSEMBLY_GROUP,
        IFNULL(GET_BEZNR(T325.BEZNR, @SPRACHNR), '') AS PURPOSE_GROUP,
        GET_LBEZNR(T1000.LBEZNR, @SPRACHNR) AS CROSS_BRAND,
        IFNULL(GET_BEZNR(T050.BEZNR, @SPRACHNR), '') AS NAME_CRY,
        IF(T050.TYP <> 'K',
            T210.KRITWERT,
            IFNULL(GET_BEZNR_FOR_KEY_TABLE(T050.TABNR, T210.KRITWERT, @SPRACHNR), '')
        ) AS VALUE_CRY,
        T532.NTYPNR AS `ktype`
    FROM `200_fixed` AS P
        JOIN `400` AS T400 ON T400.ARTNR = P.ARTNR AND T400.DLNR = P.DLNR AND T400.VKNZIELART = 16
        JOIN `532` AS T532 ON T532.NTYPNR = T400.VKNZIELNR
        JOIN `110` AS T110 ON T110.KMODNR = T532.KMODNR
        JOIN `100` AS T100 ON T100.HERNR = T110.HERNR
        JOIN `200` AS T200 ON T200.ARTNR = P.ARTNR AND T200.DLNR = P.DLNR
        JOIN `211` AS T211 ON T211.ARTNR = T200.ARTNR AND T211.DLNR = T200.DLNR
        JOIN `320` AS T320 ON T320.GENARTNR = T211.GENARTNR
        JOIN `210` AS T210 ON T210.ARTNR = T200.ARTNR AND T210.DLNR = T200.DLNR
        JOIN `050` AS T050 ON T050.DLNR IN (T200.DLNR, 9999) AND T050.KRITNR = T210.KRITNR
        JOIN `203` AS T203 ON T203.ARTNR = P.ARTNR AND T203.DLNR = P.DLNR
        JOIN `100` AS T1000 ON T100.HERNR = T203.KHERNR
        LEFT JOIN `323` AS T323 ON T323.NARTNR = T320.NARTNR
        LEFT JOIN `324` AS T324 ON T324.BGNR = T320.BGNR
        LEFT JOIN `325` AS T325 ON T325.VERWNR = T320.VERWNR
    WHERE P.ARTNR_SHORT = CLEAN_NUMBER(@ARTNR) AND P.DLNR = @DLNR
    ) AS T
ORDER BY `référence`;
